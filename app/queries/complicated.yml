---
declare:
  eql:
    operator: =
    left: $1
    right: $2
  get_country_name_eng:
    field: country.country_name_eng
  get_city:
    type: left_join
    from: city
    on:
      apply: ["eql", "city.country_id", "country.id"]
  get_customer:
    type: left_join
    from: customer
    on:
      apply: ["eql", "city.id", "customer.city_id"]
  get_call:
    type: left_join
    from: call
    on:
      apply: ["eql", "customer.id", "call.customer_id"]
  order_by:
    field: $1
    by: $2
  having_cond:
    operator: ">"
    left: AVG(ISNULL(DATEDIFF(SECOND, call.start_time, call.end_time),0))
    right: (SELECT AVG(DATEDIFF(SECOND, call.start_time, call.end_time)) FROM call)
main:
  select:
  - apply: ["get_country_name_eng"]
  from: country
  join:
  - apply: ["get_city"]
  - apply: ["get_customer"]
  - apply: ["get_call"]
  group:
  - country.id
  - country.country_name_eng
  order:
  - apply: ["order_by", "calls", "desc"]
  - apply: ["order_by", "country_id", "asc"]
  having:
  - apply: ["having_cond"]